---
import Layout from "@/src/layouts/Layout.astro"

export const prerender = false

const url = "https://api.omu-aikido.com/news"

type NewsItem = {
  id: string
  title: string
  content: string
  date?: string
}

let data: NewsItem[] = []
let fetchError: string | null = null

try {
  const res = await fetch(url)
  if (!res.ok) {
    fetchError = `ニュースの取得に失敗しました（HTTP ${res.status}）`
  } else {
    const json = await res.json()
    if (Array.isArray(json)) {
      data = json.map((d: any) => ({
        id: d?.id,
        title: d?.title ? String(d.title) : "(無題)",
        content: d?.content ? String(d.content) : "",
        date: d?.date ? String(d.date) : undefined,
      })) as NewsItem[]
    } else {
      fetchError = "API のレスポンスが予期した形式ではありません。"
    }
  }
} catch (err) {
  fetchError = "ニュースの取得中にエラーが発生しました。"
}
---

<Layout title="お知らせ" description="部の最新のニュースとお知らせを掲載しています">
  <section class="my-8 px-6">
    <div class="text-center">
      <h1 class="mb-4 text-3xl font-bold text-neutral-900 dark:text-neutral-100">
        お知らせ
      </h1>
      <p class="mx-auto mb-6 max-w-2xl text-base text-neutral-700 dark:text-neutral-300">
        合氣道部からのお知らせを掲載します。更新がある場合は随時追加されます。
      </p>
    </div>

    <div class="mx-auto max-w-4xl">
      {fetchError ? (
        <div class="mb-6 rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/20 dark:text-red-200">
          {fetchError}
        </div>
      ) : null}

      {!fetchError && data.length === 0 ? (
        <div class="mb-6 rounded-lg bg-white/80 p-6 text-center shadow-sm dark:bg-neutral-700/60">
          <p class="text-neutral-700 dark:text-neutral-300">現在、お知らせはありません。</p>
        </div>
      ) : null}

      <div class="grid gap-6">
        {data.map((item) => {
          const isLong = item.content && item.content.length > 70
          const preview = isLong
            ? item.content.slice(0, 70).trimEnd() + "…"
            : item.content || ""

          return (
            <article
              class="rounded-lg bg-white p-6 shadow-md transition-shadow duration-200 hover:shadow-lg dark:bg-neutral-700"
              role="article"
              aria-labelledby={`news-${item.id}`}
            >
              <header class="mb-2 flex items-start justify-between gap-4">
                <h2
                  id={`news-${item.id}`}
                  class="text-lg font-semibold text-neutral-900 dark:text-neutral-100"
                >
                  {item.title}
                </h2>
                {item.date ? (
                  <time
                    class="ml-auto whitespace-nowrap text-sm text-neutral-500 dark:text-neutral-300"
                    datetime={item.date}
                    aria-label={`更新日: ${item.date}`}
                  >
                    {new Date(item.date).toLocaleDateString("ja-JP")}
                  </time>
                ) : null}
              </header>

              {isLong ? (
                <details class="group">
                  <summary class="cursor-pointer list-none">
                    <div class="mb-4 group-open:hidden">
                      <p class="whitespace-pre-wrap text-sm text-neutral-700 dark:text-neutral-300">
                        {preview}
                      </p>
                    </div>
                    <div class="text-emerald-600 hover:text-emerald-700 font-semibold dark:text-emerald-400 group-open:hidden">
                      続きを読む
                    </div>
                    <div class="text-emerald-600 hover:text-emerald-700 font-semibold dark:text-emerald-400 hidden group-open:block mb-4">
                      閉じる
                    </div>
                  </summary>

                  <div class="text-sm text-neutral-700 dark:text-neutral-300">
                    <p class="whitespace-pre-wrap">{item.content}</p>
                  </div>
                </details>
              ) : (
                <div class="text-sm text-neutral-700 dark:text-neutral-300">
                  <p class="whitespace-pre-wrap">{item.content}</p>
                </div>
              )}
            </article>
          )
        })}
      </div>
    </div>
  </section>
</Layout>
